#!/bin/sh

# Example of a json payload received by this script (k8s 1.15+)
# {
#   "kubernetes.io/mounterArgs.FsGroup": "33",
#   "kubernetes.io/fsType": "",
#   "kubernetes.io/pod.name": "nginx-deployment-549ddfb5fc-rnqk8",
#   "kubernetes.io/pod.namespace": "default",
#   "kubernetes.io/pod.uid": "bb6b2e46-c80d-4c86-920c-8e08736fa211",
#   "kubernetes.io/pvOrVolumeName": "test-volume",
#   "kubernetes.io/readwrite": "rw",
#   "kubernetes.io/serviceAccount.name": "default",
#   "opts": "domain=Foo",
#   "server": "fooserver123",
#   "share": "/test"
# }
#
# k8s versions prior to 1.15 pass fsGroup differently
# {
# -  "kubernetes.io/mounterArgs.FsGroup": "33",
# +  "kubernetes.io/fsGroup": "33",
#   ...
# }

usage() {
  err "Invalid usage. Usage: "
  err "\t$0 init"
  err "\t$0 mount <mount dir> <json params>"
  err "\t$0 unmount <mount dir>"
  exit 1
}

err() {
  /bin/echo -ne $* 1>&2
}

log() {
  /bin/echo -ne $* >&1
}

## use this for logging and debugging
# logg() {
#   echo -e $* >> /tmp/asdf.log
# }

ismounted() {
  MOUNT=`findmnt -n ${MNTPATH} 2>/dev/null | cut -d' ' -f1`
  if [ "${MOUNT}" == "${MNTPATH}" ]; then
    echo "1"
  else
    echo "0"
  fi
}

domount() {
  MNTPATH=$1

  # testing with minikube
  # echo "$2" | jq '.' > /hosthome/juliohm/workspace/github/kubernetes-cifs-volumedriver/asdf.json

  CIFS_SERVER=$(echo $2 | jq -r '.server')
  CIFS_SHARE=$(echo $2 | jq -r '.share')
  PODID=$(echo $2 | jq -r '.["kubernetes.io/pod.uid"] // empty')
  DOMAIN=$(echo $2 | jq -r '.["kubernetes.io/secret/domain"] // empty' | base64 -d)
  PASSWORD=$(echo $2 | jq -r '.["kubernetes.io/secret/password"] // empty' | base64 -d)
  USERNAME=$(echo $2 | jq -r '.["kubernetes.io/secret/username"] // empty' | base64 -d)

  READWRITE=$(echo $2 | jq -r '.["kubernetes.io/readwrite"] // empty')
  if [[ "$READWRITE" == "" ]]; then
    READWRITE="rw"
  fi

  FSGROUP=$(echo $2 | jq -r '.["kubernetes.io/mounterArgs.FsGroup"] // empty')
  ## k8s versions prior to 1.15 pass fsGroup differently
  if [[ "$FSGROUP" == "" ]]; then
    FSGROUP=$(echo $2 | jq -r '.["kubernetes.io/fsGroup"] // empty')
  fi

  OPTS=$(echo $2 | jq -r '.opts')

  ## Complex passwords with symbols and special characters
  ## are a painful to deal with in a shell script.
  ## This works around that by saving credentials in a
  ## temporary file.
  FINALOPTS="credentials=/tmp/temporary.$PODID.tmp"
  if [[ "$OPTS" != "" && $OPTS != "null" ]]; then
    FINALOPTS="$FINALOPTS,$OPTS,$READWRITE"
  fi
  if [[ "$FSGROUP" != "" && "$FSGROUP" != "null" ]]; then
    FINALOPTS="$FINALOPTS,uid=$FSGROUP,gid=$FSGROUP"
  fi

  if [ $(ismounted) -eq 1 ] ; then
    log '{"status": "Success"}'
    exit 0
  fi

  mkdir -p ${MNTPATH} &> /dev/null

  rm -fr /tmp/temporary.$PODID.tmp
  touch /tmp/temporary.$PODID.tmp
  if [[ "$USERNAME" != "" ]]; then
    echo "username=$USERNAME" >> /tmp/temporary.$PODID.tmp
  fi
  if [[ "$DOMAIN" != "" ]]; then
          echo "domain=$DOMAIN" >> /tmp/temporary.$PODID.tmp
  fi
  if [[ "$PASSWORD" != "" ]]; then
          echo "password=$PASSWORD" >> /tmp/temporary.$PODID.tmp
  fi

  # testing with minikube
  # echo "mount -t cifs -o $FINALOPTS \"//$CIFS_SERVER$CIFS_SHARE\" \"$MNTPATH\" &> /dev/null" > /hosthome/juliohm/workspace/github/kubernetes-cifs-volumedriver/asdf.mount

  mount -t cifs -o $FINALOPTS "//$CIFS_SERVER$CIFS_SHARE" "$MNTPATH" &> /dev/null
  R=$?
  rm -fr /tmp/temporary.$PODID.tmp
  if [ $R -ne 0 ]; then
    err "{ \"status\": \"Failure\", \"message\": \"domain=${DOMAIN} username=${USERNAME} Failed returncode=$R mount -t cifs -o $FINALOPTS \"//$CIFS_SERVER$CIFS_SHARE\" \"$MNTPATH\"\"}"
    exit 1
  fi
  log '{"status": "Success"}'
  exit 0
}

unmount() {
  MNTPATH=$1
  if [ $(ismounted) -eq 0 ] ; then
    log '{"status": "Success"}'
    exit 0
  fi

  umount ${MNTPATH} &> /dev/null
  if [ $? -ne 0 ]; then
    err "{ \"status\": \"Failed\", \"message\": \"Failed to unmount volume at ${MNTPATH}\"}"
    exit 1
  fi

  log '{"status": "Success"}'
  exit 0
}

op=$1

if ! command -v jq >/dev/null 2>&1; then
  err "{ \"status\": \"Failure\", \"message\": \"'jq' binary not found. Please install jq package before using this driver\"}"
  exit 1
fi

if [ "$op" = "init" ]; then
  log '{"status": "Success", "capabilities": {"attach": false}}'
  exit 0
fi

if [ $# -lt 2 ]; then
  usage
fi

shift

case "$op" in
  mount)
    domount $*
    ;;
  unmount)
    unmount $*
    ;;
  *)
    log '{"status": "Not supported"}'
    exit 0
esac

exit 1
